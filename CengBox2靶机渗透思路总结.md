![ceng](images/ceng.png)

## 信息收集

靶机IP：192.168.116.171

攻击机IP：192.168.116.169

### nmap针对全端口扫描

![image-20200609091136879](images/image-20200609091136879.png)

发现21、80端口存在服务。

访问80:

![image-20200609091249619](images/image-20200609091249619.png)

进行目录扫描，没发现啥有价值的信息。

再来看看21端口。

试一试ftp是否允许匿名登陆。

![image-20200609091518426](images/image-20200609091518426.png)

可以看到靶机允许匿名登陆，并且其中存在note.txt文件。

get 该文件。

![image-20200609091625887](images/image-20200609091625887.png)

查看其内容，大概说是可以将这个ip和这个域名进行绑定。

看到这里，下一步思路就是将其绑定，暴力枚举子域名。

编辑/etc/hosts文件。

![image-20200609091759590](images/image-20200609091759590.png)

### 枚举子域

```shell
./gobuster vhost -u  ceng-company.vm -w /usr/share/wordlists/dirb/big.txt 
```

![image-20200609092632488](images/image-20200609092632488.png)

可发现带有admin二级域的，均为403.我们将其绑定/etc/hosts。

![image-20200609092735445](images/image-20200609092735445.png)

### 资源发现

尝试访问。

状态为403，然后尝试dirb 扫描其下面是否存在有效站点资源。

![image-20200609092949758](images/image-20200609092949758.png)

存在该目录，尝试访问。

![image-20200609093043413](images/image-20200609093043413.png)

尝试寻找该cms的漏洞，均无可以利用成功且有效的exp。

尝试了几次，发现站点并没有针对用户登陆次数进行限制。

还记得ftp匿名登陆的那个note.txt吗？

我们仔细看下。

![image-20200609093310566](images/image-20200609093310566.png)

在其中出现了Kevin这个用户名。

我们将这个用户名和域名拼接起来。

eg: Kevin@ceng-company.vm

然后进行弱口令猜解。

经过手动猜解发现密码是admin。

![image-20200609093449113](images/image-20200609093449113.png)

login

![image-20200609093510135](images/image-20200609093510135.png)

## 权限获取

### www-data权限获取

![image-20200609093726704](images/image-20200609093726704.png)

这边可以编辑主题，我们通过weevely生成一个php的木马。密码为1.

编辑上传。

![image-20200609093911040](images/image-20200609093911040.png)

然后将域名和地址进行拼接，发现403.

然后我们回到上层目录，发现存在.htaccess文件。

![image-20200609094011008](images/image-20200609094011008.png)

拒绝从任何地方来的php文件进行访问。

我们删除该文件。

成功访问。

![image-20200609094104551](images/image-20200609094104551.png)

通过weevely进行连接。

![image-20200609094154745](images/image-20200609094154745.png)

成功获取到www-data权限，我们通过sudo -l 来查看该用户可以通过别的权限来运行什么。

![image-20200609094325908](images/image-20200609094325908.png)

可以看到，它可以通过swartz的身份来运行这个脚本。我们cat一下。

![image-20200609094410985](images/image-20200609094410985.png)

php -a 用来运行php代码的。在该shell下执行交互式命令很不方便，于是将www-data的bash反弹出来，或者一开始就反弹出来，我一开始没想那么多。

![image-20200609095228599](images/image-20200609095228599.png)

![image-20200609095248208](images/image-20200609095248208.png)

### swartz用户权限获取

通过上文得知，runphp.sh脚本是通过该用户运行的。那我们是不是可以通过php -a ，来通过php反弹该用户的shell。

![image-20200609095502178](images/image-20200609095502178.png)

### mitnick用户权限获取

瞧瞧我们发现了什么。

![image-20200609095640474](images/image-20200609095640474.png)

![image-20200609095728882](images/image-20200609095728882.png)

该用户的ssh的公钥和私钥。但是都不可写。

我们将其私钥复制导出。

![image-20200609095826154](images/image-20200609095826154.png)

aes密钥对加密，我们通过john这款工具进行密码的尝试破解。

首先将id_rsa转化成john可识别的格式。（通过ssh2john）

通过locate发现该文件的位置。

![image-20200609100302327](images/image-20200609100302327.png)

然后通过python 执行。

![image-20200609100321863](images/image-20200609100321863.png)

通过john进行破解。

![image-20200609100348629](images/image-20200609100348629.png)

可以发现密码是legend.

我们通过私钥加上密码进行登陆。

这里需要注意一个问题，就是id_rsa文件的权限。

![image-20200609100540481](images/image-20200609100540481.png)

如果出现这样，即便是正确的密码也登陆不上去。

将该文件权限更改为700

![image-20200609100641701](images/image-20200609100641701.png)

即可登陆成功

### root权限获取

按照上面的套路，我们先sudo -l一下。

![image-20200609100717748](images/image-20200609100717748.png)

结果发现要密码，所以这块玩不转了。

我们上传pspy64（ 监控没有Root权限的Linux进程 ）到该服务器上。通过wget就可以。

![image-20200609100906341](images/image-20200609100906341.png)

我上传成功了，并且加了可执行权限。

直接运行。

![image-20200609101022314](images/image-20200609101022314.png)

我们去找uid为0的。

![image-20200609101111429](images/image-20200609101111429.png)

我们找到了这一条。

先了解下motd存在的意义。

![image-20200609101233258](images/image-20200609101233258.png)

关键点：

1. 每次启动通过root身份运行脚本

那是不是就可以在脚本中运行我们写好的反弹脚本。

在任意可写的文件夹内。

vim bash.sh

![image-20200609101627050](images/image-20200609101627050.png)

![image-20200609102544617](images/image-20200609102544617.png)

然后我们监听2222端口。随后登陆。

![image-20200609102654357](images/image-20200609102654357.png)

![image-20200609102730605](images/image-20200609102730605.png)